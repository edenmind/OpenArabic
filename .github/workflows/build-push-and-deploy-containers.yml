name: build-push-and-deploy-containers

on:
  push:
    branches: [main]
jobs:
  build-push-and-deploy-containers:
    runs-on: ubuntu-latest
    steps:
      - name: 🏗  Prepare Meta Data for Build
        id: prep
        run: |
          branch=${GITHUB_REF##*/}
          sha=${GITHUB_SHA::8}
          fullsha=${GITHUB_SHA}
          ts=$(date +%s)
          echo "::set-output name=BUILD_ID::${branch}-${sha}-${ts}"
          echo "::set-output name=GIT_SHA::${fullsha}"

      - name: 🏗  Checkout
        uses: actions/checkout@v3

      - name: 🏗  Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: 🏗  Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 🏗  Docker Login
        uses: docker/login-action@v2
        with:
          registry: registry.digitalocean.com/openarabic/
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: 🏗  Install Helm
        uses: Azure/setup-helm@v1
        with:
          version: ${{ env.HELM_VERSION_TO_INSTALL }}
        env:
          HELM_VERSION_TO_INSTALL: 3.10.1

      - name: 🏗  Login to Registry With Helm
        run: |
          helm registry login registry.digitalocean.com/openarabic --username ${{ secrets.DOCKERHUB_USERNAME }} --password ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: 🔎  Replace Commit SHA in Footer in Web
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["web/src/components/footer.js"]'
          tokenPrefix: "@("
          tokenSuffix: ")@"
        env:
          GIT_SHA: ${{ steps.prep.outputs.GIT_SHA }}

      - name: 📦  Build and Push Static to Container Registry
        uses: docker/build-push-action@v3
        with:
          file: ./static/Dockerfile
          tags: registry.digitalocean.com/openarabic/static:${{ steps.prep.outputs.BUILD_ID }}
          context: ./static
          push: true

      - name: 📦  Build and Push API to Container Registry
        uses: docker/build-push-action@v3
        with:
          file: ./api/Dockerfile
          tags: registry.digitalocean.com/openarabic/api:${{ steps.prep.outputs.BUILD_ID }}
          context: ./api
          push: true

      - name: 📦  Build and Push Services to Container Registry
        uses: docker/build-push-action@v3
        with:
          file: ./services/Dockerfile
          tags: registry.digitalocean.com/openarabic/tashkeel:${{ steps.prep.outputs.BUILD_ID }}
          context: ./services/
          push: true

      - name: 📦  Build and Push Web to Container Registry
        uses: docker/build-push-action@v3
        with:
          file: ./web/Dockerfile
          tags: registry.digitalocean.com/openarabic/web:${{ steps.prep.outputs.BUILD_ID }}
          context: ./web
          push: true
          build-args: |
            REACT_APP_API_URL: ${{ secrets.REACT_APP_KEY }}
            REACT_APP_KEY: ${{ secrets.REACT_APP_KEY }}
            REACT_APP_GOOGLE_API_KEY: ${{ secrets.REACT_APP_GOOGLE_API_KEY }}

      - name: 🔎  Replace SHA Tag for Containers and Helm Chart
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["package/**/*.yaml"]'
        env:
          BUILD_ID: ${{ steps.prep.outputs.BUILD_ID }}

      # https://github.com/marketplace/actions/kubescape
      - name: 🔎  Lint and Package
        working-directory: ./package
        run: ./build.sh

      - name: 🚀  Publish Chart to Registry
        working-directory: ./package
        env:
          HELM_EXPERIMENTAL_OCI: 1
        run: |
          helm push dist/open-arabic-helm*.tgz oci://registry.digitalocean.com/openarabic
